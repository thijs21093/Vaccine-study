---
title: "Report COVID study POOLED V100"
author: "Thijs de Boer"
date: "2021"
output:
  html_document:
    code_folding: hide
    fig_captions: yes
    highlight: haddock
    number_sections: yes
    theme: flatly
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
      toc_depth: 3
---


Last update: `r Sys.time()`

```{r set-global-options, echo = FALSE}
knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      message=FALSE,
                      warning = FALSE,
                      cache = FALSE,
                      include = TRUE,
                      collapse = FALSE,
                      dependson = NULL,
                      engine = "R", #  Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Figures/",  #  Set the figure options
                      fig.align = "left",
                      fig.width = 6,
                      fig.height = 4)
```

```{r silent-packages, echo = FALSE, eval = TRUE, message=FALSE, include = FALSE}
library(sjPlot)
library(sjstats)
library(tidyverse)
library(car)
library(ggthemes)
library(kableExtra)
library(ggpubr)
library(scales)
library(ggpmisc)
library(tadaatoolbox)
library(rockchalk)
library(lme4)
library(janitor)
library(sjmisc)
library(lavaan)
library(semPlot)
library(stargazer)
library(semTools)
library(psych)
```

```{r}
load("C:/Users/Thijs/surfdrive/COVID vaccine/git/POOLED/.RData")

set_theme(
  base=theme_blank(),
  geom.outline.size = 0.01,
  geom.outline.color = "white", 
  geom.label.size = 3,
  geom.label.color = "grey50")
```


# Population

Total number of cases, final cases, and removed cases (complete cases only):
```{r}
t1 <- df.total %>% filter(Finished == 1) %>%  
  group_by(country) %>% 
  tally() %>% 
  mutate(percentage = (n/nrow(df.total %>% filter(Finished == 1))*100)) %>%
  adorn_totals("row")

t2 <- pooled  %>% filter(Finished == 1) %>%  
  group_by(country) %>% 
  tally() %>% 
  mutate(percentage = (n/nrow(pooled %>% filter(Finished == 1))*100)) %>%
  adorn_totals("row")

t3 <- merge(x = t1, y = t2, by = "country", all.x = TRUE) %>%  mutate(n.diff = (n.x-n.y),
        percentage.diff = (n.diff/(sum(n.diff/2))*100),
        ratio = (n.y/n.x)) 

t3 %>% 
  kable(col.names = c("",
                      "n",
                      "%",
                      "n",
                      "%",
                      "n",
                      "%",
                      "Ratio (final/total)"
                      ),
        digits = 2,
        align=rep('c', 5)) %>% 
    kable_styling(bootstrap_options = c( "condensed",  "striped", "hover"),
                full_width = F,
                position = "left")  %>% add_header_above(c(" ", "Total"  = 2, "Final" = 2, "Failed IMC or under 18" = 2, " "))  %>%
   column_spec(column = 2:8, width = "2cm")
```

<br >

Number of participants in the final dataset that failed the comprehension check (complete cases only):
```{r}
t4 <- pooled %>%  filter(Finished == 1) %>%
   group_by(country, comprehension.check.failed)%>%
  summarise(n=n()) %>%
  spread(comprehension.check.failed, n) %>%
  adorn_totals("row")  %>% mutate(
   missing =  `<NA>`,
   missing = tidyr::replace_na(missing, 0),
   total = (failed + passed + missing),
  percentage = (passed/(total)*100) %>% round(2)) %>% relocate(failed, .after = passed)

t4 %>% select(-`<NA>`) %>% 
  kable(col.names = c("",
                      "Passed",
                      "Failed",
                      "Missing",
                      "Total",
                      "% Passed")) %>% 
    kable_styling(bootstrap_options = c("condensed", "striped", "hover"),
                full_width = F,
                position = "left")
```

<br>

# Outcome variables

In this section we provide additional details about our outcome variables -- the three aspects of policy credibility. We report the distributions and correlations of the six survey items. Thereafter, we include the R code and results of our confirmatory factor analysis.   


## Distributions of items

Item 1: I believe that the EMA's opinion was based strictly on scientific considerations. 

```{r}
pooled %>%
  ggplot(aes(x=credibility.item1, fill = experimental.group)) +
  geom_bar(width = 0.75, alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```

<br>

Item 2: I believe that the EMA's opinion was influenced by political interests. (reversed)


```{r}
pooled %>%
  ggplot(aes(x=credibility.item2.reversed, fill = experimental.group)) +
  geom_bar(width = 0.75,alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```


Item 3: I believe that the EMA's opinion was affected by the industry interests. (reversed)


```{r}
pooled %>%
  ggplot(aes(x=credibility.item3.reversed, fill = experimental.group)) +
  geom_bar(width = 0.75,alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```

<br>

Item 4: I believe that the EMA's opinion was formed after evaluating all the relevant data and evidence. 

```{r}
pooled %>%
  ggplot(aes(x=credibility.item4, fill = experimental.group)) +
  geom_bar(width = 0.75,alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```

<br>

Item 5: I believe that the assessment of the evidence was based on adequate methods. 

```{r}
pooled %>%
  ggplot(aes(x=credibility.item5, fill = experimental.group)) +
  geom_bar(width = 0.75,alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```

<br>

Item 6: Assuming that the scientific evidence does not change, I believe that EMA's opinion about the Pfizer-BioNTech vaccine will not change the next time EMA is asked to re-examine it.

```{r}
pooled %>%
  ggplot(aes(x=credibility.item6, fill = experimental.group)) +
  geom_bar(width = 0.75,alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```

<br>

**Correlation matrix**

```{r}
pooled.credibility <- pooled %>% 
  select(credibility.item1:credibility.item6, country) %>%
  mutate(item1 = credibility.item1,
         item2 = credibility.item2.reversed,
         item3 = credibility.item3.reversed,
         item4 = credibility.item4,
         item5 = credibility.item5,
         item6 = credibility.item6,
         .keep = "unused")

pooled.credibility %>% select(-country) %>%
  tab_corr(triangle="lower",
           remove.spaces=T,
           p.numeric = T,
           fade.ns = T,
           digits = 2,
           na.deletion="pairwise",
           title = "Correlation matrix: items of policy credibility scale",
           var.labels = str_c("Item ",1:6))
```

<br>

```{r include=FALSE}
factor.1.cfa <- 'policy.credibility  =~ item1 + item2 + item3 + item4 + item5 + item6'

factor.3.cfa.base <- 'non.interference  =~ item1 + item2 + item3
expertise =~ item4 + item5
stability   =~ item6'

factor.3.cfa.adjusted <- paste0(factor.3.cfa.base,
"\n",
"item2	~~	item3")

factor.3.cfa.alternative <- 'non.interference  =~ item2 + item3
expertise =~ item1 + item4 + item5 
stability   =~ item6'
```


# Conformitory factor analysis

We conducted our confirmatory factor analysis using `R lavaan` package.

<br>

## One-factor model - Single factor

**Model summary**
```{r,echo = TRUE}
fit.1factor <- cfa(factor.1.cfa, 
           std.lv=TRUE,  
           missing="fiml",  
           data=pooled.credibility)

summary(fit.1factor,fit.measures=T,standardize=T)
```

<br>

**Visualization of the model**
```{r}
semPaths(fit.1factor, "std",
         layout = "tree2",
         nCharNodes = 0,
         nCharEdges = 0,
         sizeMan = 12,
         sizeLat = 30,
         intercepts = FALSE,
         curvePivot = TRUE,
         edge.label.cex = 1.5,
         curveAdjacent = TRUE,
         style = "lisrel",
         label.scale = FALSE,
         nodeLabels = c(str_c("Item ",1:6), "Policy credibility")) 
```

<br > 

## Three-factors model - base

**Model summary**
```{r,echo = TRUE}
fit.3factors.base <- cfa(factor.3.cfa.base, 
           std.lv=TRUE,  
           missing="fiml",  
           data=pooled.credibility)

summary(fit.3factors.base, fit.measures=T,standardize=T)
```

<br>

**Visualization of the model**
```{r}
semPaths(fit.3factors.base,  "std",
         layout = "tree2",
         nCharNodes = 0,
         nCharEdges = 0,
         sizeMan = 8,
         sizeLat = 20,
         intercepts = FALSE,
         curvePivot = TRUE,
         edge.label.cex = 1.3,
         curveAdjacent = TRUE,
         style = "lisrel",
         label.scale = FALSE,
         label.cex = 0.65,
         nodeLabels = c(str_c("Item ",1:6), "Non-interference", "Expertise", "Stability")) 
```

<br > 

**Modification indices**
```{r}
fit.improve.base <- modificationindices(fit.3factors.base, standardized =TRUE)

fit.improve.base %>%
  as_tibble() %>%
  slice_max(mi, n = 10) %>%
  arrange(-mi) %>% 
  select( 'Left hand side' = lhs, Operator = op, 'Right hand side' = rhs, 'Modification index' = mi,  'Expected parameter change'= epc) %>%
  kable(digits = 3) %>% 
    kable_styling(bootstrap_options = c("condensed",  "striped", "hover"),
                full_width = F,
                position = "left")
```

<br>

It can be gleaned from this table that allowing item 2 and item 3 to correlate enhances the fit of the model. This makes sense as these variables are asked in a very similar way. The next model shows the result of this adjustment.

<br>

**Key parameters**
```{r}
parameterEstimates(fit.3factors.base, standardized=TRUE) %>% 
  filter(op == "=~") %>% 
  select('Latent Factor'=lhs, Indicator=rhs, B=est, SE=se, Z=z, 'p-value'=pvalue, Beta=std.all) %>% 
  mutate(Indicator = c(str_c("Item ",1:6))) %>% 
  kable(digits = 3) %>% 
    kable_styling(bootstrap_options = c("condensed"),
                full_width = F,
                position = "left")%>%
  collapse_rows(columns = 1, valign = "top")
```

## Three-factors model - adjusted

**Model summary**
```{r,echo = TRUE}
fit.3factors.adjusted <- cfa(factor.3.cfa.adjusted, 
           std.lv=TRUE,  
           missing="fiml",  
           data=pooled.credibility)

summary(fit.3factors.adjusted, fit.measures=T, standardize=T)
```

<br >

**Visualization of the model**
```{r}
semPaths(fit.3factors.adjusted,
         "std",
         layout = "tree2",
         nCharNodes = 0,
         nCharEdges = 0,
         sizeMan = 8,
         sizeLat = 20,
         intercepts = FALSE,
         curvePivot = TRUE,
         edge.label.cex = 1.3,
         curveAdjacent = TRUE,
         style = "lisrel",
         label.scale = FALSE,
         label.cex = 0.65,
         nodeLabels = c(str_c("Item ",1:6), "Non-interference", "Expertise", "Stability"))
```

<br >

**Modification indices**
```{r}
fit.improve.adjusted <- modificationindices(fit.3factors.adjusted)

fit.improve.adjusted %>%
  as_tibble() %>%
  slice_max(mi, n = 10) %>%
  arrange(-mi) %>% 
  select( 'Left hand side' = lhs, Operator = op, 'Right hand side' = rhs, 'Modification index' = mi,  'Expected parameter change'= epc) %>%
  kable(digits = 3) %>% 
    kable_styling(bootstrap_options = c("condensed",  "striped", "hover"),
                full_width = F,
                position = "left")
```

<br>

Judging from this table,  it seems that item 1 may be better assigned to the 'expertise' factor -- instead of the 'non-interference' factor. Also, note the very high correlation between non-interference and expertise and the somewhat low loadings of item 2 and item 3. The next model shows what happens if item 1 is assigned to the 'expertise' factor.

<br>

**Key parameters**
```{r}
parameterEstimates(fit.3factors.adjusted, standardized=TRUE) %>% 
  filter(op == "=~") %>% 
  select('Latent Factor'=lhs, Indicator=rhs, B=est, SE=se, Z=z, 'p-value'=pvalue, Beta=std.all) %>% 
  mutate(Indicator = c(str_c("Item ",1:6))) %>% 
  kable(digits = 3) %>% 
    kable_styling(bootstrap_options = c("condensed"),
                full_width = F,
                position = "left")%>%
  collapse_rows(columns = 1, valign = "top")
```

## Three-factors model - alternative 

**Model summary**
```{r}
fit.3factors.alternative <- cfa(factor.3.cfa.alternative, 
           std.lv=TRUE,  
           missing="fiml",  
           data=pooled.credibility)

summary(fit.3factors.alternative, standardize=T, fit.measures=T)
```

<br > 

**Visualization of the model**
```{r paged.print=FALSE}
semPaths(fit.3factors.alternative, 
         "std",
         layout = "tree2",
         nCharNodes = 0,
         nCharEdges = 0,
         sizeMan = 8,
         sizeLat = 20,
         intercepts = FALSE,
         curvePivot = TRUE,
         edge.label.cex = 1.3,
         curveAdjacent = TRUE,
         style = "lisrel",
         label.scale = FALSE,
         label.cex = 0.65,
         nodeLabels = c("Item 2", "Item 3", "Item 1", "Item 4", "Item 5", "Item 6", "Non-interference", "Expertise", "Stability"))
```

<br > 

**Modification indices**
```{r}
fit.improve.alternative <- modificationindices(fit.3factors.alternative)

fit.improve.alternative %>%
  as_tibble() %>%
  slice_max(mi, n = 10) %>%
  arrange(-mi) %>% 
  select( 'Left hand side' = lhs, Operator = op, 'Right hand side' = rhs, 'Modification index' = mi,  'Expected parameter change'= epc) %>%
  kable(digits = 3) %>% 
    kable_styling(bootstrap_options = c("condensed",  "striped", "hover"),
                full_width = F,
                position = "left")
```

<br >
No (theoretically sensible) improvements are possible.
<br >

**Key parameters**
```{r}
parameterEstimates(fit.3factors.alternative, standardized=TRUE) %>% 
  filter(op == "=~")  %>% 
 select('Latent Factor'=lhs, Indicator=rhs, B=est, SE=se, Z=z, 'p-value'=pvalue, Beta=std.all) %>%  
  mutate(Indicator = c("Item 2", "Item 3", "Item 1", "Item 4", "Item 5", "Item 6")) %>% 
  kable(digits = 3)%>% 
    kable_styling(bootstrap_options = c("condensed"),
                full_width = F,
                position = "left") %>%
  collapse_rows(columns = 1, valign = "top")
```

## Model comparison

**1 factor vs. 3 factors (base)**
```{r,echo = TRUE}
lavTestLRT(fit.3factors.base, fit.1factor)
```

<br >

**3 factors (base) vs. 3 factors (adjusted)**
```{r,echo = TRUE}
lavTestLRT(fit.3factors.base, fit.3factors.adjusted)
```

<br >

**1 factor vs. 3 factors (alternative)**
```{r}
lavTestLRT(fit.1factor, fit.3factors.alternative)
```

<br >

## Comparing models: A nice table 
```{r}
cfa.compare <- cbind(
m1 = inspect(fit.1factor, 'fit.measures'),
m2 =inspect(fit.3factors.base, 'fit.measures'),
m3= inspect(fit.3factors.adjusted, 'fit.measures'),
m4 =inspect(fit.3factors.alternative, 'fit.measures'))

cfa.compare  %>%
   t() %>%
   as_tibble() %>% 
   round(3) %>%
   unite("rmsea.ci", rmsea.ci.lower:rmsea.ci.upper, remove = FALSE, sep = " - ")  %>%
   select(Parameters = npar,
          "Chi-squared" = chisq,
          "Degrees of freedom" = df,
          "p-value" = pvalue,
          CFI = cfi,
          TLI = tli,
          AIC = aic,
          BIC = bic,
          RMSEA = rmsea,
          "RMSEA 95% CI" = rmsea.ci,
          "RMSEA p-value" = rmsea.pvalue) %>% 
   mutate(Model = c("Single factor",
                     "Baseline",
                     "Adjusted",
                     "Alternative")) %>% relocate(Model) %>%
  kable(booktabs = TRUE) %>% pack_rows(
  index = c("One factor" = 1, "Three Factors" = 3)) %>%  
    kable_styling(bootstrap_options = c("condensed",  "striped", "hover"),
                full_width = F,
                position = "left")
```

## Model per country
```{r}
fit.final.country <- cfa(factor.3.cfa.adjusted, 
           data=pooled.credibility,
          std.lv=TRUE,  
           missing="fiml",
          group = "country")

summary(fit.final.country, standardize=T, fit.measures=T)
```

<br > 

**Visualization of the model**
```{r,  fig.height=4, fig.width=16}
semPaths(fit.final.country,
         "std",
         layout = "tree2",
         nCharNodes = 0,
         nCharEdges = 0,
         intercepts = FALSE,
         curvePivot = TRUE,
         sizeMan = 14,
         sizeLat = 28,
         edge.label.cex = 2,
        label.cex = 0.8,
         style = "lisrel",
         label.scale = FALSE,
         nodeLabels = c(str_c("Item ",1:6), "Non-interference", "Expertise", "Stability"),
         panelGroups = TRUE,
         title = FALSE) 

```
<font size="0.5">

From left to right: Ireland, France, Netherlands, Sweden.

</font> 

<br > 

**Key parameters**
```{r}
parameterEstimates(fit.final.country, standardized=TRUE) %>% 
  filter(op == "=~") %>%
  mutate(Country = case_when(
    group == 1 ~ "Ireland",
    group == 2 ~ "France",
    group == 3 ~ "Netherlands",
    group == 4 ~ "Sweden"
  ))  %>% 
 select('Latent Factor'=lhs, Indicator=rhs, B=est, SE=se, Z=z, 'p-value'=pvalue, Beta=std.all, Country)  %>%
     relocate(Country) %>%
  kable(digits = 3) %>% pack_rows(
  index = c("Ireland" = 6, "France" = 6, "Netherlands" = 6, "Sweden" =6)) %>%
    kable_styling(bootstrap_options = c("condensed","striped", "hover"),
                full_width = F,
                position = "left") 
```

<br >

**Invariance** 
```{r}
invariance <- measEq.syntax(configural.model = factor.3.cfa.adjusted, 
                      data = pooled.credibility, 
                      ordered = c("item1", "item2", "item3", "item4", "item5", "item6"),
                      parameterization = "theta",
                      ID.fac = "std.lv",
                      ID.cat = "Wu.Estabrook.2016",
                      group = "country",
                      group.equal = "configural")

invariance.model <- as.character(invariance)

invaraince.fit <- cfa(invariance.model,
                    data = pooled.credibility,
                    group = "country",
                     ordered = c("item1",
                                 "item2",
                                 "item3",
                                 "item4",
                                 "item5",
                                 "item6"))

summary(invaraince.fit)

# 'MeasE1.syntax' is the successor of the now deprecated function 'measurementInvariance'. It can be used to analyze (in)variance between groups: https://lavaan.ugent.be/tutorial/groups.html.
# However, the current code gives a warning and the output seems incorrect.
# See for instructions: https://towardsdatascience.com/measurement-invariance-definition-and-example-in-r-15b4efcab351
```

<br >
This code gives a warning. Further examination is needed.
<br >

# Trust in EU institutions

## Distribution of items 

<br >

Trust in the European Parliament

```{r}
pooled %>%
  ggplot(aes(x=trust.EP, fill = experimental.group)) +
  geom_bar(width = 0.75,alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```

<br>

Trust in the European Commission

```{r}
pooled %>%
  ggplot(aes(x=trust.EC, fill = experimental.group)) +
  geom_bar(width = 0.75,alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```

<br>

Trust in the Council of the EU

```{r}
pooled %>%
  ggplot(aes(x=trust.council, fill = experimental.group)) +
  geom_bar(width = 0.75,alpha=0.8)+
  scale_x_continuous(name="",limits = c(0,8),breaks = 1:7)+
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue2","dodgerblue3", "dodgerblue4"))+
  facet_grid(experimental.group ~ country,  margins=TRUE, scale="free") + 
  theme_tufte() +
  theme(legend.position = "none", axis.title = element_blank())
```

## Correlation matrix
```{r}
pooled.trust <- pooled %>% 
  select(trust.EP, trust.EC, trust.council)

pooled.trust %>% 
  tab_corr(triangle="lower",
           remove.spaces=T,
           p.numeric = T,
           fade.ns = T,
           digits = 2,
           na.deletion="pairwise",
           title = "Correlation matrix: Trust in EU institutions",
           var.labels = c("European Parliament", "European Commission", "Council of the EU"))
```

## Reliability indices
```{r}
alpha.trust <- alpha(pooled.trust)[[1]]
alpha.trust %>% select(-c(average_r, median_r, `S/N`, ase)) %>% kable(col.names = c("Raw alpha",
                       "Standarized alpha",
                      "Guttman's Lambda 6",
                      "Mean of trust in EU institutions",
                      "SD of trust in EU institutions"),
                      digits = 3) %>% 
    kable_styling(bootstrap_options = c("condensed", "striped", "hover"),
                full_width = F,
                position = "left")
```

# Summary statistics
```{r,results="asis", echo=FALSE,warning=FALSE,message=FALSE}
q1 <- pooled %>% 
  select(expertise,
         stability,
         noninterference,
         credibility.index,
         perceived.independence.reversed,
         intent.vaccine,
         
         trust.EU.institutions,
         trust.scientist,
         trust.politicians,
         trust.media,
         political.ideology,
         EU.integration,
         interpersonal.trust,
         familiarity.EMA,
         familiarity.advice,
         credibility.EMA.pre,
         credibility.EMA.post,
         trust.health.authorities,
         consequences.health,
         consequences.economic,
         importance.EMA.recoded,
         importance.FDA.recoded,
         importance.NRA.recoded,
         private.providers,
         knowledge,
         benefits.vaccines,
         
         independence,
         advice,
         no.text,
         
         female,
         healthcare,
         age) %>% 
  descr() %>% 
  data.frame() %>% 
  select(-type,
         -label,
         -se,
         -iqr,
         -trimmed,) %>% 
mutate_at(vars(c("NA.prc","mean","sd","md", "skew")),funs(round(.,3))) %>%
  mutate(var = c(
"1. Credibility (expertise)",
"2. Credibility (stability)",
"3. Credibility (non-interference)",
"4. Credibility index",
"5. Perceived political independence",
"6. Vaccination intention",
"7. Trust in EU institutions",
"8. Trust in scientists",
"9. Trust in politicians",
"10. Trust in the media",
"11. Political ideology (left-right)",
"12. Support for EU integration",
"13. Interpersonal trust",
"14. Familiarity with EMA",
"15. Familiarity with EMA's opinion",
"16. Crebility of EMA (pre-manipulation)",
"17. Crebility of EMA (post-manipulation)",
"18. Trust in public health authorities",
"19. Consequences of coronacrisis for health",
"20. Consequences of coronacrisis for income",
"21. Importance of EMA's opinion",
"22. Importance of other regulators' opinion (e.g., FDA)",
"23. Importance of NRA's opinion",
"24. Believe in private markets",
"25. Knowledge of coronacrisis",
"26. Benefits of vaccines",
"27. Independence condition",
"28. Advice condition",
"29. No text condtion",
"30. Gender (Female = 1)",
"31. Works in healthcare",
"32. Age"))
rownames(q1) <- 1:nrow(q1)

q1 %>% 
  kable(col.names = c("Variable",
                       "n",
                      "% missing",
                      "Mean",
                      "SD",
                      "Median",
                      "Range",
                      "Skew")) %>% 
    kable_styling(bootstrap_options = c("condensed", "striped", "hover"),
                full_width = F,
                position = "left")
```

<br>

```{r}
pooled %>% 
  select(expertise,
         stability,
         noninterference,
         credibility.index,
         perceived.independence.reversed,
         intent.vaccine,
         
         trust.EU.institutions,
         trust.scientist,
         trust.politicians,
         trust.media,
         political.ideology,
         EU.integration,
         interpersonal.trust,
         familiarity.EMA,
         familiarity.advice,
         credibility.EMA.pre,
         credibility.EMA.post,
         trust.health.authorities,
         consequences.health,
         consequences.economic,
         importance.EMA,
         importance.FDA ,
         importance.NRA,
         private.providers,
         knowledge,
         benefits.vaccines,
         independence,
         advice,
         
          female,
          healthcare,
         age) %>% 
  tab_corr(triangle="lower",
           remove.spaces=T,
           p.numeric = T,
           show.p = T,
           fade.ns = F,
           digits = 2,
           na.deletion="pairwise",
           var.labels = str_c("Variable ", c(1:28,30:32)))
```

<br>

Note that I removed variable 29 ("no text") from the correlation plot as it gives an error during computation.

# Experiment: Perceived independence of EMA

<br>

## Randomisation check
This table shows how many respondents are assigned to each experimental group.
```{r}
pooled %>%
  group_by(experimental.group) %>%
  tally() %>%
  kable(col.names = c("Experimental group", "n")) %>%
    kable_styling(bootstrap_options = c("condensed", "striped", "hover"),
                full_width = F,
                position = "left") 
```

<br>

## Histogram
```{r}
pooled %>%
  ggplot(aes(x = perceived.independence.reversed, fill = experimental.group)) +
  geom_bar(width = 0.9, position = position_dodge()) + scale_y_continuous(name="") +
  scale_x_continuous(name="", breaks = 1:7) + scale_fill_manual(name = "Independence group") +  scale_fill_viridis_d(name = "Independence group") + facet_grid(~country, margins = T) + theme_tufte() + theme(strip.text = element_text(hjust = 0, face = "bold"),
    legend.position="bottom",
    aspect.ratio = 2.5)
```

<br>

## T-test

```{r}
ggarrange(pooled  %>% ggplot(aes(x = experimental.group, y = perceived.independence.reversed, color = experimental.group)) +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha = 0.5, width = 0.1, size = 1, position = position_dodge(0.5)) + labs(color ='Experimental group', x = "", y = "", title = "Complete dataset") +
    stat_summary(fun = mean, geom = "point", alpha = 0.5, size = 2 , position = position_dodge(0.5)) +  facet_grid(.~country, margins = TRUE) +  theme_tufte() + theme(axis.text.x = element_blank(), axis.ticks = element_blank()),
    
    pooled %>% filter(comprehension.check.failed == "passed") %>% ggplot(aes(x = experimental.group, y = perceived.independence.reversed, color = experimental.group)) +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha = 0.5, width = 0.1, size = 1, position = position_dodge(0.5)) + labs(color ='Experimental group', x = "", y = "", title = "Only those who passed the comprehension check") +
    stat_summary(fun = mean, geom = "point", alpha = 0.5, size = 2 , position = position_dodge(0.5)) +  facet_grid(.~country, margins = TRUE) +  theme_tufte() + theme(axis.text.x = element_blank(), axis.ticks = element_blank()), nrow = 1, common.legend =  TRUE, legend = "bottom")
```

<br>

### With complete dataset (only advice/independence)
```{r}
tadaa_t.test(data = pooled.experiment, response = perceived.independence.reversed, group = experimental.group, print = "markdown")
```

<br>

### With those who failed the comprehension check filtered out (only advice/independence)
```{r}
tadaa_t.test(data = pooled.experiment.check, response = perceived.independence.reversed, group = experimental.group, print = "markdown")
```

# Time

<br>

```{r include=FALSE}
table.duration <- pooled %>%
  dplyr::summarize(mean = mean(duration),
            sd = sd(duration),
            min = min(duration),
            q1 = quantile(duration, probs = 0.25),
            median = median(duration),
            q3 = quantile(duration, probs = 0.75),
            max = max(duration)) %>% round(digits = 2)

table.intro.submit <- pooled %>% 
   dplyr::summarize(mean = mean(intro.submit),
            sd = sd(intro.submit),
            min = min(intro.submit),
            q1 = quantile(intro.submit, probs = 0.25),
            median = median(intro.submit),
            q3 = quantile(intro.submit, probs = 0.75),
            max = max(intro.submit)) %>% round(digits = 2)

table.manipulation.submit <- pooled %>% drop_na(manipulation.submit) %>% 
   dplyr::summarize(mean = mean(manipulation.submit),
            sd = sd(manipulation.submit),
            min = min(manipulation.submit),
            q1 = quantile(manipulation.submit, probs = 0.25),
            median = median(manipulation.submit),
            q3 = quantile(manipulation.submit, probs = 0.75),
            max = max(manipulation.submit)) %>% round(digits = 2)

table.decision.submit <- pooled %>% 
   dplyr::summarize(mean = mean(decision.submit),
            sd = sd(decision.submit),
            min = min(decision.submit),
            q1 = quantile(decision.submit, probs = 0.25),
            median = median(decision.submit),
            q3 = quantile(decision.submit, probs = 0.75),
            max = max(decision.submit)) %>% round(digits = 2)
```

<br>

## Survey duration

<br>

### Histogram
```{r}
pooled %>% filter(duration < 30) %>% 
plot_frq((duration),
        geom.colors = scales::alpha("red",0.8),
        type = "hist",
        geom.size = 0.25) +
  theme(axis.text = element_text(face = "bold",  size= 9)) + labs(title = "Total survey duration") +  scale_x_continuous(name="Time in minutes", breaks = seq(0,30, 2)) +  scale_y_continuous(expand = expansion(c(0, 0.25))) + annotate(geom = "table", x = Inf, y = Inf, label = list(table.duration))
```

<br>

## Do participants read the information about the case?

<br>

### Page submission - introduction of case
```{r}
pooled %>% filter(intro.submit < 100) %>%  
plot_frq((intro.submit),
        geom.colors = scales::alpha("dodgerblue2",0.8),
        type = "hist",
        geom.size = 1) + 
  theme(axis.text = element_text(face = "bold",  size= 9)) +
  scale_x_continuous(name="Time in seconds",breaks = seq(0,100,5)) +   scale_y_continuous(expand = expansion(c(0, 0.1))) + annotate(geom = "table", x = Inf, y = Inf, label = list(table.intro.submit))
```

<br>

### Page submission - manipulation

<br>

*Histogram*
```{r}
pooled %>% filter(manipulation.submit < 100) %>%
plot_frq((manipulation.submit),
        geom.colors = scales::alpha("dodgerblue2",0.8),
        type = "hist",
        geom.size = 1) +
  theme(axis.text = element_text(face = "bold",  size= 9)) +
  scale_x_continuous(name="Time in seconds",breaks = seq(0,100,5)) +   scale_y_continuous(expand = expansion(c(0, 0.1))) + annotate(geom = "table", x = Inf, y = Inf, label = list(table.manipulation.submit))
```

<br>

<br>

*Difference in perceived independence with 30 seconds as cut-off point + number of cases per group*
```{r}
give.n <- function(x){
  return(c(y = mean(x)*1.15, label = length(x))) 
}

t8 <- pooled.experiment  %>% ggplot(aes(x = manipulation.submit.30,y = perceived.independence.reversed, color = experimental.group)) +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha = 0.5, width = 0.1, size = 1, position = position_dodge(0.25)) + labs(color ='Experimental group', x = "Page submission - manipulation", y = "Perceived independence") +
    stat_summary(fun = mean, geom = "point", alpha = 0.5, size = 2 , position=position_dodge(0.25)) +  facet_grid(. ~ country, margins = TRUE) +
  stat_summary(fun.data = give.n, geom = "text", fun = median, size = 4, col = "black") + theme_tufte() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
ggarrange(t8, common.legend = TRUE, legend = "bottom")
```

<br >

*Broken down in quartiles per counry and total*
```{r}
t9 <- pooled.experiment  %>% ggplot(aes(x = manipulation.submit.quartile,y = perceived.independence.reversed, color = experimental.group)) +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha = 0.5, width = 0.1, size = 1, position = position_dodge(0.5)) + labs(color ='Experimental group', x = "Page submission - manipulation (quartiles)", y = "Perceived independence") +
    stat_summary(fun = mean, geom = "point", alpha = 0.5, size = 2 , position=position_dodge(0.5)) +  facet_grid(. ~ country, margins = TRUE) +  theme_tufte()
  
ggarrange(t9, common.legend = TRUE, legend = "bottom")
```

### Page submission - EMA's decision
```{r}
pooled %>% filter(decision.submit < 100) %>% 
plot_frq((decision.submit),
        geom.colors = scales::alpha("dodgerblue2",0.8),
        type = "hist",
        geom.size = 1) + 
  theme(axis.text = element_text(face = "bold",  size= 9)) +
  scale_x_continuous(name= "Time in seconds", breaks = seq(0,100,5)) +   scale_y_continuous(expand = expansion(c(0, 0.1))) + annotate(geom = "table", x = Inf, y = Inf, label = list(table.decision.submit))
```

<br>

## Time and ...

<br>

***...Failing the comprehension check***

```{r}
t10 <- pooled.experiment %>% filter(duration < 30) %>% drop_na(comprehension.check.failed) %>%
  ggplot(aes(x= duration, color = comprehension.check.failed, fill = comprehension.check.failed)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 2) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Total survey duration", x = "minutes") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t11  <- pooled.experiment %>% filter(intro.submit < 60) %>% drop_na(comprehension.check.failed) %>% ggplot(aes(x= intro.submit, color = comprehension.check.failed, fill = comprehension.check.failed)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - introduction", x = "seconds") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t12 <- pooled.experiment %>% filter(manipulation.submit < 60) %>% drop_na(comprehension.check.failed) %>% ggplot(aes(x=manipulation.submit, color = comprehension.check.failed, fill = comprehension.check.failed)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) + geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - manipulation", x = "seconds") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t13 <- pooled.experiment %>% filter(decision.submit < 60) %>% drop_na(comprehension.check.failed) %>% ggplot(aes(x=decision.submit, color =comprehension.check.failed, fill = comprehension.check.failed)) + 
 geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - EMA's decision", x = "seconds") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

ggarrange(t10, t11, t12, t13, nrow = 2, ncol = 2, labels="AUTO", legend = "bottom", common.legend = TRUE)

# Change legend title
```

<br>

***...experimental groups***

```{r}
t14 <- pooled.experiment %>% filter(duration < 30) %>% ggplot(aes(x= duration, color = experimental.group, fill = experimental.group)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 2) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Total survey duration", x = "minutes") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t15  <- pooled.experiment %>% filter(intro.submit < 60) %>% ggplot(aes(x= intro.submit, color = experimental.group, fill = experimental.group)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - introduction", x = "seconds") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t16 <- pooled.experiment %>% filter(manipulation.submit < 60) %>% ggplot(aes(x=manipulation.submit, color = experimental.group, fill = experimental.group)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) + geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - manipulation", x = "seconds") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t17 <- pooled.experiment %>% filter(decision.submit < 60) %>% ggplot(aes(x=decision.submit, color = experimental.group, fill = experimental.group)) +
 geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - EMA's decision", x = "seconds", color = "Comprehension check") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

ggarrange(t14, t15, t16, t17, nrow = 2, ncol = 2, labels="AUTO", legend = "bottom", common.legend = TRUE)
```

<br>

To check if there is a significant difference in the time indicators, I ran four t-test. Note that I removed cases that were 1.5 times outside the inter-quartile range (iqr), as these cases can be considered outliers. However, this approach is contested and other strategies may be more appropiate here. 

<br > 

```{r include=FALSE}
out.duration <- boxplot(pooled.experiment$duration, plot=FALSE)$out
out.duration <-pooled.experiment[-which(pooled.experiment$duration %in% out.duration),]

out.intro.submit <- boxplot(pooled.experiment$intro.submit, plot=FALSE)$out
out.intro.submit <-pooled.experiment[-which(pooled.experiment$intro.submit %in% out.intro.submit),]

out.manipulation.submit <- boxplot(pooled.experiment$manipulation.submit, plot=FALSE)$out
out.manipulation.submit <-pooled.experiment[-which(pooled.experiment$manipulation.submit %in% out.manipulation.submit),]

out.decision.submit <- boxplot(pooled.experiment$decision.submit, plot=FALSE)$out
out.decision.submit <-pooled.experiment[-which(pooled.experiment$decision.submit %in% out.decision.submit),]
```

***Survey duration***
```{r}
tadaa_t.test(data = out.duration, response = duration, group = experimental.group, print = "markdown")
```

***Page submission - Introduction***
```{r}
tadaa_t.test(data = out.intro.submit, response = intro.submit, group = experimental.group, print = "markdown")
```

***Page submission - manipulation***
```{r}
tadaa_t.test(data = out.manipulation.submit, response = manipulation.submit, group = experimental.group, print = "markdown")
```

***Page submission - decision***
```{r}
tadaa_t.test(data = out.decision.submit, response = decision.submit, group = experimental.group, print = "markdown")
```

<br>

***...interface (pc/mobile)***

```{r}
t18 <- pooled %>% filter(duration < 30) %>% ggplot(aes(x= duration, color = device, fill = device)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 2) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Total survey duration", x = "minutes") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t19 <- pooled %>% filter(intro.submit < 60) %>% ggplot(aes(x= intro.submit, color = device, fill = device)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - introduction", x = "seconds") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t20 <- pooled %>% filter(manipulation.submit < 60) %>% ggplot(aes(x=manipulation.submit, color = device, fill = device)) + geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) + geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - manipulation", x = "seconds") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

t21 <- pooled %>% filter(decision.submit < 60) %>% ggplot(aes(x=decision.submit, color = device, fill = device)) +
 geom_histogram(aes(y=..density..), alpha=0.5, position="identity", binwidth = 5) +
 geom_density(alpha= .1, linetype= "dashed") + labs(title = "Page submission - EMA's decision", x = "seconds") + theme(axis.title.y = element_blank(), title = element_text(size = 7, face = "bold"),  axis.text = element_text(size = 9))

ggarrange(t18, t19, t20, t21, nrow = 2, ncol = 2, labels="AUTO", legend = "bottom", common.legend = TRUE)
```

<br>



<br>

# Interface (mobile/pc)

<br>

## Distribution
```{r}
pooled %>%
  plot_frq(device,
        ylim = c(0,nrow(pooled)),
        geom.colors = scales::alpha("dodgerblue1",0.8))+
  theme_blank()
```

<br>

## Distribution of perceived independence for mobile/pc
```{r}
pooled %>%
  ggplot(aes(x = perceived.independence.reversed, fill = device)) + 
  geom_bar(width = 0.8, alpha = 1, position = position_dodge()) +  scale_x_continuous(name="Perceived independence", breaks = 1:7) + scale_y_continuous(name="") +  scale_fill_manual(name = "Device", values = c("dodgerblue2","dodgerblue4")) + facet_grid(~country, margins = TRUE) + theme_tufte() +  theme(legend.position="bottom")
```

<br>

```{r}
tadaa_t.test(data = pooled.experiment, response = perceived.independence.reversed, group = device, print = "markdown")
```

<br>

# Demography

## Age {.tabset}

### France
```{r}
age.population.FR <- read.csv("C:/Users/Thijs/surfdrive/COVID vaccine/git/FR/AGE_FR-08022021.csv")

age.population.FR <- age.population.FR %>% mutate(agecat = case_when(age < 25 ~ "younger than 25",
          age >= 25 & age < 30 ~ "25-29",
          age >= 30 & age < 35 ~ "30-34",
          age >= 35 & age < 40 ~ "35-39",
          age >= 40 & age < 45 ~ "40-44",
          age >= 45 & age < 50 ~ "45-49",
          age >= 50 & age < 55 ~ "50-54",
          age >= 55 & age < 60 ~ "55-59",
          age >= 60 & age < 65 ~ "60-64",
          age >= 65 & age < 70 ~ "65-69",
          age >= 70 & age < 75 ~ "70-74",
          age >= 75 & age < 80 ~ "75-79",
          age >= 80 ~ "80 or older"))
  
age.population.5.FR <- age.population.FR %>% group_by(agecat) %>% tally(count) %>% mutate(percentage = n / sum(n))

age.total.FR <- merge(age.population.5.FR, age.sample.FR, by.x = "agecat", by.y = "age.5")

age.total.FR <- age.total.FR %>% 
  rename(age.category = agecat,
  count.population = n.x,
  count.sample = n.y,
  percentage.population = percentage.x,
  percentage.sample = percentage.y)

age.total.FR$age.category <- factor(age.total.FR$age.category, levels = c(
"younger than 25",
"25-29",           "30-34",           "35-39",          
"40-44",           "45-49",           "50-54",          
"55-59",           "60-64",           "65-69",          
"70-74",           "75-79",           "80 or older"))    

age.total.FR %>% select(age.category, percentage.population, percentage.sample) %>% reshape2::melt(id.vars = 'age.category', variable.name = 'series')  %>% ggplot(aes(age.category, value, colour = series, fill = series)) + geom_bar (stat="identity", width=0.9, position = position_dodge(width=0.9)) + 
  theme_blank() + theme(legend.position="top", axis.text.x = element_text(angle = 45, hjust = 1), axis.title  = element_blank()) + scale_y_continuous(labels=scales::percent)
```

<br>

### Netherlands
```{r}
age.population.5.NL <- read.csv("C:/Users/Thijs/surfdrive/COVID vaccine/git/NL/AGE_POPULATION_SEGMENTS_NL-22012021.csv")

age.total.NL <- merge(age.population.5.NL, age.sample.NL, by.x = "ï..age", by.y = "age.5")

age.total.NL <- age.total.NL %>% 
  rename(age.category = ï..age,
  count.population = count,
  count.sample = n,
  percentage.population = percentage.x,
  percentage.sample = percentage.y)

age.total.NL$age.category <- factor(age.total.NL$age.category, levels = c(
"younger than 25",
"25-29",           "30-34",           "35-39",          
"40-44",           "45-49",           "50-54",          
"55-59",           "60-64",           "65-69",          
"70-74",           "75-79",           "80 or older"))    

age.total.NL %>% select(age.category, percentage.population, percentage.sample) %>% reshape2::melt(id.vars = 'age.category', variable.name = 'series')  %>% ggplot(aes(age.category, value, colour = series, fill = series)) + geom_bar (stat="identity", width=0.9, position = position_dodge(width=0.9)) + 
  theme_blank() + theme(legend.position="top", axis.text.x = element_text(angle = 45, hjust = 1), axis.title  = element_blank()) + scale_y_continuous(labels=scales::percent)
```

### Ireland
```{r}

age.population.5.IE <- read.csv("C:/Users/Thijs/surfdrive/COVID vaccine/git/EN/AGE_POPULATION_SEGMENTS_EN_25012021.csv")

age.total.IE <- merge(age.population.5.IE, age.sample.IE, by.x = "ï..age", by.y = "age.5")

age.total.IE  <- age.total.IE  %>% 
  rename(age.category = ï..age,
  count.population = count,
  count.sample = n,
  percentage.population = percentage.x,
  percentage.sample = percentage.y)

age.total.IE$age.category <- factor(age.total.IE$age.category, levels = c(
"younger than 25",
"25-29",           "30-34",           "35-39",          
"40-44",           "45-49",           "50-54",          
"55-59",           "60-64",           "65-69",          
"70-74",           "75-79",           "80 or older"))    

age.total.IE  %>% select(age.category, percentage.population, percentage.sample) %>% reshape2::melt(id.vars = 'age.category', variable.name = 'series')  %>% ggplot(aes(age.category, value, colour = series, fill = series)) + geom_bar (stat="identity", width=0.9, position = position_dodge(width=0.9)) + 
  theme_blank() + theme(legend.position="top", axis.text.x = element_text(angle = 45, hjust = 1), axis.title  = element_blank()) + scale_y_continuous(labels=scales::percent)
```

### Sweden
```{r}
age.population.5.SE <- read.csv("C:/Users/Thijs/surfdrive/COVID vaccine/git/SE/AGE_POPULATION_SEGMENTS_SE-22012021.csv")
age.total.SE <- merge(age.population.5.SE, age.sample.SE, by.x = "age", by.y = "age.5")

age.total.SE <- age.total.SE %>% 
  rename(age.category = age,
  count.population = count,
  count.sample = n,
  percentage.population = percentage.x,
  percentage.sample = percentage.y)

age.total.SE$age.category <- factor(age.total.SE$age.category, levels = c(
"younger than 25",
"25-29",           "30-34",           "35-39",          
"40-44",           "45-49",           "50-54",          
"55-59",           "60-64",           "65-69",          
"70-74",           "75-79",           "80 or older"))    

age.total.SE %>% select(age.category, percentage.population, percentage.sample) %>% reshape2::melt(id.vars = 'age.category', variable.name = 'series')  %>% ggplot(aes(age.category, value, colour = series, fill = series)) + geom_bar (stat="identity", width=0.9, position = position_dodge(width=0.9)) + 
  theme_blank() + theme(legend.position="top", axis.text.x = element_text(angle = 45, hjust = 1), axis.title  = element_blank()) + scale_y_continuous(labels=scales::percent)
```


## Gender
```{r}
pooled %>% 
plot_frq(female,
                ylim = c(0,nrow(pooled)),
        axis.labels = c("Male","Female"),
        title = "Gender")+ 
  theme_blank()
```

<br>

## Education

Not included yet.

<br>

## Income

Not included yet.

<br>

## Province

Not included yet.

<br>

## Works in healthcare sector
```{r}
pooled %>% 
  plot_frq(healthcare.recoded,
        ylim = c(0,nrow(pooled)+500),
        title = "") + 
  theme_blank()
```

<br>

# Pre-post

## Distribution of credibility EMA (post)
```{r}
pooled %>% count(credibility.EMA.post) %>%
  mutate(percentage = (n/(sum(n))*100))  %>%
  adorn_totals("row") %>% 
    kable(col.names = c("Credibility EMA (post)",
                        "n",
                        "%")
          , digits = 2) %>% 
    kable_styling(bootstrap_options = c("condensed", "striped", "hover"),
                full_width = F,
                position = "left")
```

<br >

As this variable was added later to the survey, there is substantial missing data for this variable.

<br >

## Plot
```{r warning=TRUE}
t26 <- pooled  %>% 
  select(experimental.group,
         credibility.EMA.pre,
         credibility.EMA.post,
         country) %>% drop_na(credibility.EMA.post) %>%
  gather("key","value",-experimental.group, -country) %>% 
  mutate(key = recode(key,"'credibility.EMA.pre'='0.Pre';'credibility.EMA.post'='1.Post'"))
  
t26 %>% ggplot(aes(x=key,y=value,color=experimental.group))+
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha=0.5,width=0.1,size=1,position=position_dodge(0.5)) + 
  stat_summary(fun = mean, geom = "point", alpha=0.5,size=2,position=position_dodge(0.5))+
  stat_summary(fun = mean, geom = "line", alpha=0.5,size=1,position=position_dodge(0.5), aes(group = experimental.group)) + labs(color ='Experimental group', x = "", y = "") + facet_grid(~country, margins = TRUE) +
  theme_tufte()
```

<br >

## Regression {.tabset}

### Total

**Models**
```{r}
prepost.total <- pooled %>% mutate(id = row_number()) %>% 
  select(experimental.group,
         id,
         credibility.EMA.pre,
         credibility.EMA.post,
         country) %>%
  drop_na() %>%
  gather("key","value",-experimental.group,-id,-country) %>% 
  mutate(post = key %>% Recode("'credibility.EMA.pre'= 0;'credibility.EMA.post'=1"),
         credibility = value) 


m1 <- lmer(credibility ~ post + (1|id),
                       data = prepost.total)

m2 <- m1 %>% update(.~.+experimental.group) 


m3 <- m2 %>% update(.~. + post*experimental.group)


tab_model(m2, m3,
          show.ci = F,
          show.se = T,
          collapse.se = T,
          emph.p = F)
```

<br >

**Interaction effect**
```{r}
plot_model(m3, type = "int")
```

### Ireland

**Models**
```{r}
prepost.IE <- prepost.total %>% filter(country == "IE")

m5 <- lmer(credibility ~ post + (1|id), data = prepost.IE)

m6 <- m5 %>% update(.~.+experimental.group) 

m7 <- m6 %>% update(.~. + post*experimental.group)

tab_model(m6, m7,
          show.ci = F,
          show.se = T,
          collapse.se = T,
          emph.p = F)
```

<br > 

**Interaction effect**
```{r}
plot_model(m7, type = "int")
```

### Sweden
```{r}
prepost.SE <- prepost.total %>% filter(country == "SE")

m8 <- lmer(credibility ~ post + (1|id),
                       data = prepost.SE)

m9 <- m8 %>% update(.~.+ experimental.group) 

m10 <- m9 %>% update(.~. + post*experimental.group)

tab_model(m9, m10,
          show.ci = F,
          show.se = T,
          collapse.se = T,
          emph.p = F)
```

<br > 

**Interaction effect**
```{r}
plot_model(m10, type = "int")
```

### France

**Models**
```{r}
prepost.FR <- prepost.total %>% filter(country == "FR")

m11 <- lmer(credibility ~ post + (1|id),
                       data = prepost.FR)

m12 <- m11 %>% update(.~.+ experimental.group) 

m13 <- m12 %>% update(.~. + post*experimental.group)

tab_model(m12, m13,
          show.ci = F,
          show.se = T,
          collapse.se = T,
          emph.p = F)
```

<br > 

**Interaction effect**
```{r}
plot_model(m13, type = "int")
```

<br > 

# Explaining perceived political independence
```{r results='asis'}
pooled.regression <- pooled # To do: select variables included in regression model

r1.1 <- lm(perceived.independence.reversed ~
         trust.EU.institutions +
         trust.scientist +
         trust.politicians +
         political.ideology +
         EU.integration +
         interpersonal.trust +
         familiarity.EMA +
         familiarity.advice +
         credibility.EMA.pre +
         trust.health.authorities +
         consequences.health +
         consequences.economic +
         importance.EMA.recoded +
         importance.FDA.recoded +
         importance.NRA.recoded +
         private.providers +
         knowledge +
         benefits.vaccines,
                    data = pooled.regression,
                    na.action = na.omit)


r1.2 <- stats::update(r1.1, . ~ . + experimental.group)
          
r1.3 <- stats::update(r1.2, . ~ . +
        female +
         healthcare +
         poly(age, 2) +
         country) 
         
r1.4 <- stats::update(r1.3, . ~ . + trust.media)

stargazer(r1.1,
          r1.2,
          r1.3,
          r1.4,
  report = "vcsp",
  style = "apsr",
  omit.stat = c("ser", "f"),
  type = "html",
  dep.var.labels = "Perceived political independence",
  initial.zero = FALSE,
  notes = "*Notes*: Table entries are non-standardized OLS-regression coefficients, with standard errors in parentheses.",
  notes.append = FALSE
)
```

<br >

# Explaining vaccination intention

## Distribution of variable




```{r}
pooled  %>%
  ggplot(aes(intent.vaccine, group = country)) + 
          geom_bar(aes(y = ..prop..), stat="count") + 
          scale_y_continuous(labels=scales::percent) +
          labs(y = "Relative frequencies", x = "Vaccination intention") +
          facet_grid(~country, margins = TRUE) + theme_light()
```

<br >
This variable has been recoded. Answer categories 1 and 2 are recoded as 0. Answer caterogies 3 and 4 are recoded as 1.
<br > 

## Regression models
```{r results='asis'}
r2.1 <- glm(intent.vaccine.recoded ~ credibility.index,
                    data = pooled.regression,
                    na.action = na.omit,
                    family = binomial(link = 'logit'))


r2.2 <- stats::update(r2.1, . ~ . + 
         trust.EU.institutions +
         trust.scientist +
         trust.politicians +
         political.ideology +
         EU.integration +
         interpersonal.trust +
         familiarity.EMA +
         familiarity.advice +
         credibility.EMA.pre +
         trust.health.authorities +
         consequences.health +
         consequences.economic +
         importance.EMA.recoded +
         importance.FDA.recoded +
         importance.NRA.recoded +
         private.providers +
         knowledge +
         benefits.vaccines)
          
r2.3 <- stats::update(r2.2, . ~ . +
          female +
         healthcare +
         poly(age, 2) +
         country) 
         
r2.4 <- stats::update(r2.3, . ~ . +
                        trust.media)

stargazer(r2.1,
          r2.2,
          r2.3,
          r2.4,
  report = "vcsp",
  style = "apsr",
  omit.stat = c("ser", "f"),
  type = "html",
  dep.var.labels = "Vaccination intention",
  initial.zero = FALSE,
  notes = "*Notes*: Generalized Linear Model",
  notes.append = FALSE
)

```

<br>

# Explaning crebility of EMA's opinion

## Stability

### Distribution of variable
```{r}
pooled %>%
  ggplot(aes(stability, group = country)) + 
          geom_bar(aes(y = ..prop..), stat="count") + 
          scale_y_continuous(labels=scales::percent) +
          scale_x_continuous(breaks = NULL) +
          labs(y = "Relative frequencies", x = "Stability") + 
          facet_grid(~country, margins = TRUE) + theme_light()
```

### Effect of the manipulation
```{r}
pooled  %>% ggplot(aes(x = experimental.group, y = stability, color = experimental.group)) +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha = 0.5, width = 0.1, size = 1, position = position_dodge(0.5)) + labs(color ='Experimental group', x = "", y = "") +
    stat_summary(fun = mean, geom = "point", alpha = 0.5, size = 2 , position = position_dodge(0.5)) +  facet_grid(.~country, margins = TRUE) +  theme_tufte() + theme(axis.text.x = element_blank(), axis.ticks = element_blank())
```

## Regression models
```{r results='asis'}
r3.1 <- lm(stability  ~ perceived.independence.reversed + 
         trust.EU.institutions +
         trust.scientist +
         trust.politicians +
         political.ideology +
         EU.integration +
         interpersonal.trust +
         familiarity.EMA +
         familiarity.advice +
         credibility.EMA.pre +
         trust.health.authorities +
         consequences.health +
         consequences.economic +
         importance.EMA.recoded +
         importance.FDA.recoded +
         importance.NRA.recoded +
         private.providers +
         knowledge +
         benefits.vaccines +
        female +
         healthcare +
         poly(age, 2) +
         country,
                    data = pooled,
                    na.action = na.omit)

r3.2 <- stats::update(r3.1, . ~ . -
            perceived.independence.reversed +
            experimental.group) 
         
r3.3 <- stats::update(r3.1, . ~ . + 
            benefits.vaccines:perceived.independence.reversed) %>% meanCenter(centerOnlyInteractors = TRUE, centerDV = FALSE)

r3.4 <- stats::update(r3.2, . ~ . + 
            benefits.vaccines:experimental.group) %>% meanCenter(centerOnlyInteractors = TRUE, centerDV = FALSE)

stargazer(r3.1,
          r3.3,
          r3.2,
          r3.4,
  report = "vcsp",
  style = "apsr",
  omit.stat = c("ser", "f"),
  type = "html",
  dep.var.labels = "Stability",
  initial.zero = FALSE,
  notes = "*Notes*: Table entries are non-standardized OLS-regression coefficients, with standard errors in parentheses.",
  notes.append = FALSE
)

# Trust in media not yet included.
```

<br > 
**Interaction effect: Perceived political independence X Benefits of vaccines**
```{r}
plot_model(r3.3, type = "int", mdrt.values = "meansd")
```

## Expertise

### Distribution of variable
```{r}
pooled %>%
  ggplot(aes(expertise, group = country)) + 
          geom_bar(aes(y = ..prop..), stat="count") + 
          scale_y_continuous(labels=scales::percent) +
          scale_x_continuous(breaks = NULL) +
          labs(y = "Relative frequencies", x = "Expertise") +
          facet_grid(~country, margins = TRUE) + theme_light()
```

### Effect of the manipulation
```{r}
pooled  %>% ggplot(aes(x = experimental.group, y = expertise, color = experimental.group)) +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha = 0.5, width = 0.1, size = 1, position = position_dodge(0.5)) + labs(color ='Experimental group', x = "", y = "") +
    stat_summary(fun = mean, geom = "point", alpha = 0.5, size = 2 , position = position_dodge(0.5)) +  facet_grid(.~country, margins = TRUE) +  theme_tufte() + theme(axis.text.x = element_blank(), axis.ticks = element_blank())
```

## Regression models
```{r results='asis'}
r4.1 <- lm(expertise  ~ perceived.independence.reversed + 
         trust.EU.institutions +
         trust.scientist +
         trust.politicians +
         political.ideology +
         EU.integration +
         interpersonal.trust +
         familiarity.EMA +
         familiarity.advice +
         credibility.EMA.pre +
         trust.health.authorities +
         consequences.health +
         consequences.economic +
         importance.EMA.recoded +
         importance.FDA.recoded +
         importance.NRA.recoded +
         private.providers +
         knowledge +
         benefits.vaccines +
        female +
         healthcare +
         poly(age, 2) +
         country,
                    data = pooled,
                    na.action = na.omit)

r4.2 <- stats::update(r4.1, . ~ . -
            perceived.independence.reversed +
            experimental.group) 
         
r4.3 <- stats::update(r4.1, . ~ . + 
            benefits.vaccines:perceived.independence.reversed) %>% meanCenter(centerOnlyInteractors = TRUE, centerDV = FALSE)

r4.4 <- stats::update(r4.2, . ~ . + 
            benefits.vaccines:experimental.group) %>% meanCenter(centerOnlyInteractors = TRUE, centerDV = FALSE)

stargazer(r4.1,
          r4.3,
          r4.2,
          r4.4,
  report = "vcsp",
  style = "apsr",
  omit.stat = c("ser", "f"),
  type = "html",
  dep.var.labels = "Expertise",
  initial.zero = FALSE,
  notes = "*Notes*: Table entries are non-standardized OLS-regression coefficients, with standard errors in parentheses.",
  notes.append = FALSE
)

# Trust in media not yet included.
```

<br > 

**Interaction effect: Perceived political independence X Benefits of vaccines**
```{r}
plot_model(r4.3, type = "int", mdrt.values = "meansd")
```

## Non-interference

### Distribution of variable
```{r}
pooled %>%
  ggplot(aes(noninterference, group = country)) + 
          geom_bar(aes(y = ..prop..), stat="count") + 
          scale_y_continuous(labels=scales::percent) +
          scale_x_continuous(breaks = NULL) +
          labs(y = "Relative frequencies", x = "Non-interference") +
          facet_grid(~country, margins = TRUE) + theme_light()
```

### Effect of the manipulation
```{r}
pooled  %>% ggplot(aes(x = experimental.group, y = noninterference, color = experimental.group)) +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha = 0.5, width = 0.1, size = 1, position = position_dodge(0.5)) + labs(color ='Experimental group', x = "", y = "") +
    stat_summary(fun = mean, geom = "point", alpha = 0.5, size = 2 , position = position_dodge(0.5)) +  facet_grid(.~country, margins = TRUE) +  theme_tufte() + theme(axis.text.x = element_blank(), axis.ticks = element_blank())
```

## Regression models
```{r results='asis'}
r5.1 <- lm(noninterference  ~ perceived.independence.reversed + 
         trust.EU.institutions +
         trust.scientist +
         trust.politicians +
         political.ideology +
         EU.integration +
         interpersonal.trust +
         familiarity.EMA +
         familiarity.advice +
         credibility.EMA.pre +
         trust.health.authorities +
         consequences.health +
         consequences.economic +
         importance.EMA.recoded +
         importance.FDA.recoded +
         importance.NRA.recoded +
         private.providers +
         knowledge +
         benefits.vaccines +
        female +
         healthcare +
         poly(age, 2) +
         country,
                    data = pooled,
                    na.action = na.omit)

r5.2 <- stats::update(r5.1, . ~ . -
            perceived.independence.reversed +
            experimental.group) 
         
r5.3 <- stats::update(r5.1, . ~ . + 
            benefits.vaccines:perceived.independence.reversed) %>% meanCenter(centerOnlyInteractors = TRUE, centerDV = FALSE)

r5.4 <- stats::update(r5.2, . ~ . + 
            benefits.vaccines:experimental.group) %>% meanCenter(centerOnlyInteractors = TRUE, centerDV = FALSE)

stargazer(r5.1,
          r5.3,
          r5.2,
          r5.4,
  report = "vcsp",
  style = "apsr",
  omit.stat = c("ser", "f"),
  type = "html",
  dep.var.labels = "Non-interference",
  initial.zero = FALSE,
  notes = "*Notes*: Table entries are non-standardized OLS-regression coefficients, with standard errors in parentheses.",
  notes.append = FALSE
)

# Trust in media not yet included.
```

<br > 

**Interaction effect: Perceived political independence X Benefits of vaccines**
```{r}
plot_model(r5.3, type = "int", mdrt.values = "meansd")
```



## Crebility index

### Distribution of variable
```{r}
pooled %>%
  ggplot(aes(credibility.index, group = country)) + 
          geom_bar(aes(y = ..prop..), stat="count") + 
          scale_y_continuous(labels=scales::percent) +
          scale_x_continuous(breaks = NULL) +
          labs(y = "Relative frequencies", x = "Credibility index") +
          facet_grid(~country, margins = TRUE) + theme_light()
```

### Effect of the manipulation
```{r}
pooled  %>% ggplot(aes(x = experimental.group, y = credibility.index, color = experimental.group)) +
      stat_summary(fun.data = mean_cl_normal, geom = "errorbar", alpha = 0.5, width = 0.1, size = 1, position = position_dodge(0.5)) + labs(color ='Experimental group', x = "", y = "") +
    stat_summary(fun = mean, geom = "point", alpha = 0.5, size = 2 , position = position_dodge(0.5)) +  facet_grid(.~country, margins = TRUE) +  theme_tufte() + theme(axis.text.x = element_blank(), axis.ticks = element_blank())
```

## Regression models
```{r results='asis'}
r6.1 <- lm(credibility.index  ~ perceived.independence.reversed + 
         trust.EU.institutions +
         trust.scientist +
         trust.politicians +
         political.ideology +
         EU.integration +
         interpersonal.trust +
         familiarity.EMA +
         familiarity.advice +
         credibility.EMA.pre +
         trust.health.authorities +
         consequences.health +
         consequences.economic +
         importance.EMA.recoded +
         importance.FDA.recoded +
         importance.NRA.recoded +
         private.providers +
         knowledge +
         benefits.vaccines +
        female +
         healthcare +
         poly(age, 2) +
         country,
                    data = pooled,
                    na.action = na.omit)

r6.2 <- stats::update(r6.1, . ~ . -
            perceived.independence.reversed +
            experimental.group) 
         
r6.3 <- stats::update(r6.1, . ~ . + 
            benefits.vaccines:perceived.independence.reversed) %>% meanCenter(centerOnlyInteractors = TRUE, centerDV = FALSE)

r6.4 <- stats::update(r6.2, . ~ . + 
            benefits.vaccines:experimental.group) %>% meanCenter(centerOnlyInteractors = TRUE, centerDV = FALSE)

stargazer(r6.1,
          r6.3,
          r6.2,
          r6.4,
  report = "vcsp",
  style = "apsr",
  omit.stat = c("ser", "f"),
  type = "html",
  dep.var.labels = "Credibility index",
  initial.zero = FALSE,
  notes = "*Notes*: Table entries are non-standardized OLS-regression coefficients, with standard errors in parentheses.",
  notes.append = FALSE
)

# Trust in media not yet included.
```

<br > 

**Interaction effect: Perceived political independence X Benefits of vaccines**
```{r}
plot_model(r6.3, type = "int", mdrt.values = "meansd")
```

# Remarks from participants

## General
```{r}
df.total %>% 
  filter(nchar(comments.general)>1) %>% 
  select(comments.general) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%    scroll_box(height = "400px")
```

## Vaccination intention
```{r}
pooled %>% 
  filter(nchar(Q16.3)>1) %>% 
  select(Q16.3) %>% 
  kable() %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%    scroll_box(height = "400px")
```
